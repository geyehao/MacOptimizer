# Mac优化大师 v4.0.1 更新日志

**发布日期**: 2026-01-09
**重要性**: 🔴 **紧急安全更新 (强烈建议所有用户立即升级)**

---

## 🛡️ 核心安全修复 (Security Fixes)

本次更新重点修复了可能导致系统文件误删的高危漏洞，并引入了全新的底层安全守卫机制。

### 1. 修复 ResidualFileScanner 模糊匹配漏洞
- **问题描述**:在此前版本中，残留文件扫描逻辑会将 Bundle ID 拆分为单词进行匹配（例如 `com.apple.safari` 会被拆分为 `apple`），导致文件名中仅包含 `apple` 的无关文件（包括系统文件）可能被误判为应用残留。
- **修复措施**: 移除了危险的 Bundle ID 拆分匹配逻辑。现在仅支持**完整 Bundle ID** 或**完整应用名称**的精准匹配，彻底根除误判风险。

### 2. 加固底层删除逻辑 (FileRemover & JunkCleaner)
- **问题描述**: 某些高级清理功能（如深度垃圾清理）需要使用 `rm -rf` 命令，旧版本缺乏对传入路径的二次强制校验，存在路径参数被污染或逻辑错误导致误删系统路径的理论风险。
- **修复措施**: 
    - 在所有高权限删除操作前强制引入 **SafetyGuard** 校验。
    - 建立了严格的**路径白名单**（仅允许 `/Users/`, `/Applications/` 等安全区域）。
    - 建立了**系统黑名单**（严禁操作 `/System`, `/usr`, `/bin`, `/Library` 等系统根目录）。
    - 即使上层逻辑错误传入了系统路径，底层也会自动拦截并拒绝执行，确保防线稳固。

### 3. 全局安全代码审计
- **优化**: 对 `OptimizerView`（一键优化）和 `JunkCleaner` 模块进行了全面审计，在所有涉及文件删除的代码路径中均增加了 `SafetyGuard` 检查。

---

## ✨ 体验与交互优化 (Experience & Interaction)

### 1. 智能扫描 (Smart Scan) 交互升级
- **分体式操作逻辑**: 优化了列表项的点击交互。现在点击列表项主体可**直接切换选择状态**，点击右侧箭头或详情区域才进入详情页，操作更加直观高效。
- **全区域点击支持**: 所有的文件和应用列表项均支持点击整行来选中/取消选中，无需精确点击复选框。

### 2. 统计数据精准化
- **实时选中统计**: 修复了“系统垃圾”和“应用缓存”的统计逻辑。现在底部显示的清理总大小会根据用户的实时勾选情况动态变化，仅统计**当前已选中**的项目大小，而非整个分类的总大小，让用户对清理量有准确预期。

---

## 🛠️ 构建与稳定性 (Build & Stability)

### 1. 修复 macOS 13 SDK 编译错误
- **问题**: 修复了 `TrashView.swift` 中使用了 macOS 14+ 新特性 (`.symbolEffect`) 导致在旧版 Xcode 或 macOS 13 SDK 环境下编译失败的问题。
- **解决**: 移除不兼容的视觉特效代码，确保在 macOS 13+ 系统上均可顺利编译和运行。

### 2. 版本号更新
- 应用版本号及构建脚本已同步更新至 **4.0.1**。

---

## 📝 升级指南
由于涉及到应用签名变更，建议用户：
1. 下载新的 DMG 安装包。
2. 覆盖安装到「应用程序」文件夹。
3. 如果遇到“已损坏”提示，请在终端执行修复命令：
   ```bash
   sudo xattr -cr /Applications/Mac优化大师.app
   ```
